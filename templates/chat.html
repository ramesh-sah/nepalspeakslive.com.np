<!-- Chat Widget -->
<div id="chatWidget" class="fixed bottom-6 right-6 z-50">
    <!-- Chat Button -->
    <button id="chatToggle" class="w-14 h-14 bg-black rounded-lg shadow-xl flex items-center justify-center hover:shadow-2xl transform hover:scale-110 transition-all duration-300 group border-2 border-white">
        <svg class="w-6 h-6 text-white transform group-hover:rotate-12 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
        <div class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
    </button>

    <!-- Chat Container -->
    <div id="chatContainer" class="hidden absolute bottom-16 right-0 w-80 sm:w-96 h-[500px]">
        <div class="w-full h-full max-w-md bg-white rounded-2xl shadow-2xl border border-gray-300 flex flex-col">
            <!-- Chat header -->
            <div class="flex items-center justify-between p-4 border-b border-gray-300 bg-white rounded-t-2xl">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-black rounded-full shadow-md flex items-center justify-center border border-gray-400">
                        <!-- Bot SVG Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v4m0 8v4m4-8h4M4 12h4m2-6a2 2 0 104 0m-4 12a2 2 0 104 0M6.343 6.343l2.828 2.828M14.828 14.828l2.828 2.828M6.343 17.657l2.828-2.828M14.828 9.172l2.828-2.828"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-gray-900">EverBot</h2>
                        <div class="flex items-center space-x-1">
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            <span class="text-xs text-gray-600">Online</span>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-1">
                    <button id="newChatBtn" class="p-2 text-gray-600 hover:text-black hover:bg-gray-100 rounded-lg transition-all duration-200" title="New Chat">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                    </button>
                    <button id="minimizeChat" class="p-2 text-gray-600 hover:text-black hover:bg-gray-100 rounded-lg transition-all duration-200" title="Minimize">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Chat messages area -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                <!-- Welcome message will be added by JavaScript -->
            </div>

            <!-- Message input area -->
            <div class="p-4 border-t border-gray-300 bg-white rounded-b-2xl">
                <div class="flex items-center space-x-3">
                    <div class="flex-1">
                        <input 
                            type="text" 
                            id="messageInput" 
                            placeholder="Type your message..."
                            class="w-full px-4 py-3 rounded-xl border border-gray-300 bg-white text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all duration-200"
                            autocomplete="off"
                        >
                    </div>
                    <button id="sendMessage" class="p-3 bg-black text-white rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-black focus:ring-offset-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Custom scrollbar */
#chatMessages::-webkit-scrollbar {
    width: 6px;
}
#chatMessages::-webkit-scrollbar-track {
    background: #f8f9fa;
    border-radius: 3px;
}
#chatMessages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}
#chatMessages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Message animations */
.chat-message-enter {
    opacity: 0;
    transform: translateY(10px);
}
.chat-message-enter-active {
    opacity: 1;
    transform: translateY(0);
    transition: opacity 300ms, transform 300ms;
}

/* Typing animation */
@keyframes typing {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-10px); }
}
.typing-dot {
    animation: typing 1.4s infinite;
}
.typing-dot:nth-child(2) {
    animation-delay: 0.2s;
}
.typing-dot:nth-child(3) {
    animation-delay: 0.4s;
}

/* BBC-inspired colors and effects */
.user-message {
    background: linear-gradient(135deg, #000000, #2d2d2d);
}
.ai-message {
    background: #ffffff;
    border: 1px solid #e5e7eb;
}
.message-timestamp {
    color: #6b7280;
}

/* Responsive design */
@media (max-width: 640px) {
    #chatContainer {
        width: 90vw;
        right: 5vw;
        max-width: none;
    }
}
@media (max-width: 480px) {
    #chatContainer {
        width: 95vw;
        right: 2.5vw;
        height: 70vh;
    }
    .chat-toggle {
        width: 12vw;
        height: 12vw;
        min-width: 50px;
        min-height: 50px;
    }
}

/* Hover effects */
.chat-button-hover:hover {
    background: #333333;
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}
.input-focus:focus {
    border-color: #000000;
    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
}
</style>

<script>
class ChatWidget {
    constructor() {
        this.isOpen = false;
        this.isLoading = false;
        this.hasAutoOpened = false;
        this.initializeElements();
        this.attachEventListeners();
        this.loadFromStorage();
        this.autoOpenChat();
    }

    initializeElements() {
        this.chatToggle = document.getElementById('chatToggle');
        this.chatContainer = document.getElementById('chatContainer');
        this.chatMessages = document.getElementById('chatMessages');
        this.messageInput = document.getElementById('messageInput');
        this.sendButton = document.getElementById('sendMessage');
        this.newChatBtn = document.getElementById('newChatBtn');
        this.minimizeBtn = document.getElementById('minimizeChat');
    }

    autoOpenChat() {
        setTimeout(() => {
            if (!this.hasAutoOpened && !this.isOpen) {
                this.toggleChat();
                this.hasAutoOpened = true;
                if (this.chatMessages.children.length === 0) {
                    this.addWelcomeMessage();
                }
            }
        },180000  );
    }

    addWelcomeMessage() {
        const welcomeTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const welcomeDiv = document.createElement('div');
        welcomeDiv.className = 'flex items-start space-x-3';
        welcomeDiv.innerHTML = `
            <div class="w-8 h-8 bg-black rounded-full flex-shrink-0 flex items-center justify-center shadow-md border border-gray-400">
                <span class="text-xs font-bold text-white">E</span>
            </div>
            <div class="bg-white p-3 rounded-2xl shadow-md border border-gray-300 max-w-[80%]">
                <p class="text-sm text-gray-900">Hello! I'm your EverBot assistant. How can I help you with your adventure today?</p>
                <span class="text-xs text-gray-500 mt-1 block">${welcomeTime}</span>
            </div>
        `;
        this.chatMessages.appendChild(welcomeDiv);
        this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
    }

    attachEventListeners() {
        this.chatToggle.addEventListener('click', () => this.toggleChat());
        this.minimizeBtn.addEventListener('click', () => this.toggleChat());
        this.sendButton.addEventListener('click', () => this.sendMessage());
        this.messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
        this.newChatBtn.addEventListener('click', () => this.startNewChat());
    }

    toggleChat() {
        this.isOpen = !this.isOpen;
        if (this.isOpen) {
            this.chatContainer.classList.remove('hidden');
            this.messageInput.focus();
            if (this.chatMessages.children.length === 0) {
                this.addWelcomeMessage();
            }
        } else {
            this.chatContainer.classList.add('hidden');
        }
    }

    async sendMessage() {
        const message = this.messageInput.value.trim();
        if (!message || this.isLoading) return;
        this.addMessage('user', message);
        this.messageInput.value = '';
        this.showTypingIndicator();
        try {
            const response = await fetch('/chat/api/send/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.getCSRFToken() },
                body: JSON.stringify({ message })
            });
            const data = await response.json();
            this.hideTypingIndicator();
            if (data.success) {
                this.addMessage('assistant', data.assistant_response);
            } else {
                this.addMessage('assistant', `Sorry, I encountered an error: ${data.error}`);
            }
        } catch (error) {
            this.hideTypingIndicator();
            this.addMessage('assistant', 'Sorry, I am unable to respond at the moment. Please try again later.');
        }
        this.saveToStorage();
    }

    addMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex items-start space-x-3 ${role === 'user' ? 'justify-end' : ''}`;
        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        if (role === 'user') {
            messageDiv.innerHTML = `
                <div class="flex flex-col items-end space-y-1 max-w-[80%]">
                    <div class="bg-black text-white p-3 rounded-2xl shadow-md border border-gray-400">
                        <p class="text-sm">${this.escapeHtml(content)}</p>
                    </div>
                    <span class="text-xs text-gray-500">${timestamp}</span>
                </div>
                <div class="w-8 h-8 bg-gray-600 rounded-full flex-shrink-0 flex items-center justify-center shadow-md border border-gray-400">
                    <span class="text-xs font-medium text-white">You</span>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="w-8 h-8 bg-black rounded-full flex-shrink-0 flex items-center justify-center shadow-md border border-gray-400">
                    <span class="text-xs font-bold text-white">E</span>
                </div>
                <div class="flex flex-col space-y-1 max-w-[80%]">
                    <div class="bg-white p-3 rounded-2xl shadow-md border border-gray-300">
                        <p class="text-sm text-gray-900">${this.escapeHtml(content)}</p>
                    </div>
                    <span class="text-xs text-gray-500">${timestamp}</span>
                </div>
            `;
        }
        messageDiv.classList.add('chat-message-enter');
        this.chatMessages.appendChild(messageDiv);
        setTimeout(() => { messageDiv.classList.add('chat-message-enter-active'); }, 10);
        this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
    }

    showTypingIndicator() {
        this.isLoading = true;
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typing-indicator';
        typingDiv.className = 'flex items-start space-x-3';
        typingDiv.innerHTML = `
            <div class="w-8 h-8 bg-black rounded-full flex-shrink-0 flex items-center justify-center shadow-md border border-gray-400">
                <span class="text-xs font-bold text-white">E</span>
            </div>
            <div class="bg-white p-3 rounded-2xl shadow-md border border-gray-300">
                <div class="flex space-x-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                </div>
            </div>
        `;
        this.chatMessages.appendChild(typingDiv);
        this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
    }

    hideTypingIndicator() {
        this.isLoading = false;
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) typingIndicator.remove();
    }

    async startNewChat() {
        try {
            await fetch('/chat/api/new/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.getCSRFToken() }
            });
            this.chatMessages.innerHTML = '';
            this.addWelcomeMessage();
            this.clearStorage();
        } catch (error) {
            console.error('Error starting new chat:', error);
        }
    }

    escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    saveToStorage() {
        const messages = Array.from(this.chatMessages.children).map(child => {
            const isUser = child.classList.contains('justify-end');
            const content = child.querySelector('p')?.textContent || '';
            return { role: isUser ? 'user' : 'assistant', content };
        });
        localStorage.setItem('chatHistory', JSON.stringify(messages));
    }

    loadFromStorage() {
        const saved = localStorage.getItem('chatHistory');
        if (saved) {
            const messages = JSON.parse(saved);
            messages.forEach(msg => this.addMessage(msg.role, msg.content));
        } else {
            this.addWelcomeMessage();
        }
    }

    clearStorage() {
        localStorage.removeItem('chatHistory');
    }
}

// Initialize chat widget when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new ChatWidget();
});
</script>
